const els={grupo:document.getElementById('grupo'),saveGrupo:document.getElementById('saveGrupo'),job:document.getElementById('job'),amount:document.getElementById('amount'),desc:document.getElementById('desc'),photo:document.getElementById('photo'),saveBtn:document.getElementById('saveBtn'),clearBtn:document.getElementById('clearBtn'),status:document.getElementById('status'),tabs:Array.from(document.querySelectorAll('.tab[data-range]')),list:document.getElementById('list'),summary:document.getElementById('summary'),search:document.getElementById('search'),forceSync:document.getElementById('forceSync'),};let currentRange='day',unsubscribe=null,items=[];function loadGrupo(){const g=localStorage.getItem('gastos_grupo')||'';els.grupo.value=g;return g;}function saveGrupo(){const g=(els.grupo.value||'').trim().toUpperCase();if(!g){alert('Coloca un código de equipo (ej: REYES2025)');return;}localStorage.setItem('gastos_grupo',g);subscribe();}els.saveGrupo.addEventListener('click',saveGrupo);function startOfWeek(d){const dt=new Date(d);const day=(dt.getDay()+6)%7;dt.setHours(0,0,0,0);dt.setDate(dt.getDate()-day);return dt;}function endOfWeek(d){const s=startOfWeek(d);const e=new Date(s);e.setDate(s.getDate()+7);return e;}function startOfMonth(d){const dt=new Date(d);return new Date(dt.getFullYear(),dt.getMonth(),1,0,0,0,0);}function endOfMonth(d){const dt=new Date(d);return new Date(dt.getFullYear(),dt.getMonth()+1,1,0,0,0,0);}function $m(n){return Number(n||0).toLocaleString('en-US',{style:'currency',currency:'USD'});}function fmt(ts){return new Date(ts).toLocaleString();}function filterRange(arr){const now=new Date();let from=new Date(0),to=new Date(8640000000000000);if(currentRange==='day'){from=new Date(now);from.setHours(0,0,0,0);to=new Date(now);to.setHours(24,0,0,0);}else if(currentRange==='week'){from=startOfWeek(now);to=endOfWeek(now);}else if(currentRange==='month'){from=startOfMonth(now);to=endOfMonth(now);}return arr.filter(x=>currentRange==='all'?true:(x.date>=from.getTime()&&x.date<to.getTime()));}function render(){const q=(els.search.value||'').toLowerCase().trim();const filtered=filterRange(items).filter(x=>!q||(x.job||'').toLowerCase().includes(q)||(x.desc||'').toLowerCase().includes(q));const total=filtered.reduce((s,x)=>s+(Number(x.amount)||0),0);els.summary.innerHTML=`<span class="pill"><b>Total:</b> ${$m(total)}</span><span class="pill"><b>Registros:</b> ${filtered.length}</span>`;els.list.innerHTML='';for(const it of filtered){const div=document.createElement('div');div.className='item';const title=document.createElement('h4');title.textContent=`${it.job||'(sin trabajo)'} — ${$m(it.amount)}`;const meta=document.createElement('small');meta.textContent=fmt(it.date);const desc=document.createElement('div');desc.textContent=it.desc||'';div.append(title,meta,desc);if(it.photoUrl){const img=document.createElement('img');img.src=it.photoUrl;img.className='thumb';div.appendChild(img);}els.list.appendChild(div);}}async function handleSave(){if(!window.db){alert('Falta configurar Firebase (config.js).');return;}const grupo=loadGrupo();if(!grupo){alert('Configura primero el Código de equipo.');return;}const job=els.job.value.trim();const amount=parseFloat(els.amount.value||'0');const desc=els.desc.value.trim();const ts=Date.now();let photoUrl=null;if(els.photo.files&&els.photo.files[0]){const f=els.photo.files[0];const path=`${grupo}/${new Date(ts).toISOString().slice(0,10)}/${ts}_${f.name}`;const ref=storage.ref().child(path);await ref.put(f);photoUrl=await ref.getDownloadURL();}await db.collection('gastos').add({grupo,job,amount,desc,date:ts,photoUrl});els.job.value='';els.amount.value='';els.desc.value='';els.photo.value=null;els.status.textContent='Guardado ✔';setTimeout(()=>els.status.textContent='',1500);}function subscribe(){if(!window.db){return;}const grupo=loadGrupo();if(unsubscribe)unsubscribe();if(!grupo){items=[];render();return;}unsubscribe=db.collection('gastos').where('grupo','==',grupo).orderBy('date','desc').onSnapshot(s=>{items=s.docs.map(d=>({id:d.id,...d.data()}));render();},err=>{console.warn(err);els.status.textContent='Offline…';});}els.saveBtn.addEventListener('click',handleSave);els.clearBtn.addEventListener('click',()=>{els.job.value='';els.amount.value='';els.desc.value='';els.photo.value=null;});els.search.addEventListener('input',render);els.forceSync.addEventListener('click',()=>subscribe());els.tabs.forEach(t=>t.addEventListener('click',()=>{els.tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');currentRange=t.dataset.range;render();}));loadGrupo();subscribe();